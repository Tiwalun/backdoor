{% extends "layout.html" %}
{% block body %}
    <h4>Add new token</h4>
    {% include 'add_token.html' %}
    <h4>Existing tokens</h4>
    <table class="table table-striped table_tokens">
        <thead>
        <tr>
            <td class="col-lg-1">ID</td>
            <td class="col-lg-3">Owner</td>
            <td class="col-lg-3">Expiry Date</td>
            <td class="col-lg-3">Creation Date</td>
            <td class="col-lg-1">Remove?</td>
            <td class="col-lg-1">Revoke?</td>
        </tr>
        </thead>
        <tbody>
        {% for token in tokens %}
            <tr>
                <td>{{ token.id }}</td>
                <td><a href="{{ url_for('list_users', attribute='id', value=token.owner.id) }}">{{ token.owner.name or 'FREE' }}</a></td>
                <td>
                    <form class="change_token_expiry_date" action="{{ url_for('change_token_expiry_date') }}" method=post>
                        <div class="input-group">
                            <input type="text" name="change_token_expiry_date" class="form-control" title="Token owner" value="{{ token.expiry_date }}" readonly />
                            <span class="input-group-btn">
                                <button class="btn btn-default button_change_token_expiry_date" type="submit">
                                    <span class="glyphicon glyphicon-pencil" aria-hidden="true">
                                    </span>
                                </button>
                            </span>
                        </div>
                        <input type="text" name="change_token_id" class="invisible" title="" value="{{ token.id }}" />
                    </form>
                </td>
                <td>{{ token.creation_date }}</td>
                <td>
                    <form class="remove_form" action="{{ url_for('remove_token') }}" method=post>
                        <input type="submit" class="btn btn-default btn-danger" value="Remove" />
                        <input name="token_id" class="invisible" value="{{ token.id }}" title="Token id"/>
                    </form>
                </td>
                <td>
                    {% if token.expiry_date > date %}
                        <form class="revoke_form" action="{{ url_for('revoke_token') }}" method=post>
                            <input type="submit" class="btn btn-default btn-warning" value="Revoke" />
                            <input name="token_id" class="invisible" value="{{ token.id }}" title="Token id"/>
                        </form>
                    {% else %}
                        <form class="activation_form" action="{{ url_for('activate_token') }}" method=post>
                            <input type="submit" class="btn btn-default btn-success" value="Activate" />
                            <input name="token_id" class="invisible" value="{{ token.id }}" title="Token id"/>
                        </form>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td colspan="6" class="col-lg-12" style="text-align: left">
                    {%  for device in token.devices %}
                        <form style="float: left; margin-right: 10px" action="{{ url_for('remove_link_token_to_device') }}" method="POST">
                            <div class="btn-group" role="group" aria-label="..." style="float: left">
                                <button type="button" class="btn btn-default" onclick="window.location.href='{{ url_for('list_devices', attribute='id', value=device.id) }}'">{{ device.name }}</button>
                                <button type="submit" class="btn btn-default"><span class="glyphicon-minus"></span></button>
                            </div>
                        <input type="text" name="remove_link_token_to_device_device_id" class="invisible" value="{{ device.id }}">
                        <input type="text" name="remove_link_token_to_device_token_id" class="invisible" value="{{ token.id }}">
                        </form>
                    {% endfor %}
                        <form action="{{ url_for('link_token_to_device') }}" method="POST">
                            <div class="input-group device_typeahead">
                                <input type="text" name="link_token_name" class="typeahead form-control device_typeahead_name" title="Device" value="" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default button_link_token" type="submit" style="margin-top: -5px">
                                        <span class="glyphicon glyphicon-ok" aria-hidden="true">
                                        </span>
                                    </button>
                                </span>
                            </div>
                            <input type="text" name="link_token_device_id" class="invisible device_typeahead_id" title="" value="" />
                            <input type="text" name="link_token_id" class="invisible" title="" value="{{ token.id }}" />
                        </form>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="6" class="col-lg-12">Unbelievable. No tokens here so far.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <script type="text/javascript">

        init_edit_field('.button_change_token_expiry_date');

        user_typeahead();
        device_typeahead();
    </script>
{% endblock %}
